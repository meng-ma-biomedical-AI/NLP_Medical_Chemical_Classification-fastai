kind: remote
metadata:
  name: model-server
  hash: 42dc40490a6e3961d808a2cdf179e108f61a4500
  project: default
  labels:
    author: nschenone
  categories:
  - serving
  - ml
spec:
  command: ''
  args: []
  image: ''
  description: nlp fastai model server
  min_replicas: 1
  max_replicas: 4
  env:
  - name: MODEL_CLASS
    value: ClassifierModel
  - name: ENABLE_EXPLAINER
    value: 'False'
  config:
    spec.triggers.http:
      kind: http
      maxWorkers: 1
      attributes:
        ingresses: {}
      annotations: {}
  base_spec:
    apiVersion: nuclio.io/v1
    kind: nuclio:serving
    metadata:
      annotations:
        nuclio.io/generated_by: function generated from 13-08-2020 by nschenone
      labels: {}
      name: model-server
    spec:
      build:
        baseImage: docker-registry.default-tenant.app.groupwaretech.iguazio-c0.com:80/fastai
        commands:
        - python -m pip install numpy cloudpickle v3io sklearn
        functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmZyb20gb3MgaW1wb3J0IGVudmlyb24KZnJvbSBjbG91ZHBpY2tsZSBpbXBvcnQgbG9hZAppbXBvcnQgbnVtcHkgYXMgbnAKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IG1scnVuCmltcG9ydCBmYXN0YWkKZnJvbSBmYXN0YWkudGV4dCBpbXBvcnQgKgpmcm9tIGZhc3RhaS5jYWxsYmFja3MgaW1wb3J0ICoKCmNsYXNzIENsYXNzaWZpZXJNb2RlbChtbHJ1bi5ydW50aW1lcy5NTE1vZGVsU2VydmVyKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lOiBzdHIsIG1vZGVsX2Rpcjogc3RyKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKG5hbWUsIG1vZGVsX2RpcikKICAgICAgICBzZWxmLkRBVEFfQ0xBU19QQVRIID0gZW52aXJvblsnREFUQV9DTEFTX1BBVEgnXQogICAgICAgIHNlbGYuTU9ERUxfUEFUSCA9IGVudmlyb25bJ01PREVMX1BBVEgnXQogICAgICAgIHNlbGYuTlVNX1BSRURTID0gaW50KGVudmlyb25bJ05VTV9QUkVEUyddKQogICAgICAgIHNlbGYubG9hZGVkID0gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgbG9hZChzZWxmKToKICAgICAgICAiIiJCeXBhc3MgbG9hZGluZyBoZXJlIGR1ZSB0byBmYXN0YWkgZXJyb3IgKHByaW50cyBwcmV0cmFpbmVkIG1vZGVsCiAgICAgICAgdG8gY29uc29sZSB3aGljaCBtbHJ1biBpbnRlcnByZXRzIGFzIGFuIGVycm9yKSIiIgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGxvYWRfbW9kZWwoc2VsZik6CiAgICAgICAgIiIiTG9hZCBtb2RlbCIiIgogICAgICAgIHNlbGYuZGF0YV9jbGFzID0gbG9hZF9kYXRhKCIiLCBzZWxmLkRBVEFfQ0xBU19QQVRILCBicz0zMikKICAgICAgICBzZWxmLmxlYXJuX2NsYXMgPSB0ZXh0X2NsYXNzaWZpZXJfbGVhcm5lcihzZWxmLmRhdGFfY2xhcywgQVdEX0xTVE0pCiAgICAgICAgc2VsZi5tb2RlbCA9IHNlbGYubGVhcm5fY2xhcy5sb2FkKHNlbGYuTU9ERUxfUEFUSCkKCiAgICBkZWYgcHJlZGljdChzZWxmLCBib2R5OiBkaWN0KSAtPiBMaXN0OgogICAgICAgICIiIkdlbmVyYXRlIG1vZGVsIHByZWRpY3Rpb25zIGZyb20gc2FtcGxlLgogICAgICAgIAogICAgICAgIDpwYXJhbSBib2R5IDogQSBkaWN0IG9mIG9ic2VydmF0aW9ucywgZWFjaCBvZiB3aGljaCBpcyBhbiAxLWRpbWVuc2lvbmFsIGZlYXR1cmUgdmVjdG9yLgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zIG1vZGVsIHByZWRpY3Rpb25zIGFzIGEgYExpc3RgLCBvbmUgZm9yIGVhY2ggcm93IGluIHRoZSBgYm9keWAgaW5wdXQgYExpc3RgLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IHNlbGYubG9hZGVkOgogICAgICAgICAgICAgICAgc2VsZi5sb2FkZWQgPSBUcnVlCiAgICAgICAgICAgICAgICBzZWxmLmxvYWRfbW9kZWwoKQogICAgICAgICAgICAKICAgICAgICAgICAgdGV4dCA9IGJvZHlbJ2luc3RhbmNlcyddCiAgICAgICAgICAgIHByZWQgPSBzZWxmLm1vZGVsLnByZWRpY3QodGV4dCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlkeHMgPSBbXQogICAgICAgICAgICBwcmVkX2xhYmVscyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmVkcyA9IGxpc3QobnAuYXJnc29ydChwcmVkWzJdKSlbOjotMV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBwIGluIHByZWRzWzpzZWxmLk5VTV9QUkVEU106CiAgICAgICAgICAgICAgICBpZHhzLmFwcGVuZChwLml0ZW0oKSkKICAgICAgICAgICAgZm9yIGlkeCBpbiBpZHhzOgogICAgICAgICAgICAgICAgcHJlZF9sYWJlbHMuYXBwZW5kKHNlbGYuZGF0YV9jbGFzLmNsYXNzZXNbaWR4XSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdDogbnAubmRhcnJheSA9IG5wLmFzYXJyYXkocHJlZF9sYWJlbHMpCiAgICAgICAgICAgIHJlc3AgPSByZXN1bHQudG9saXN0KCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmIkZhaWxlZCB0byBwcmVkaWN0IHtlfSIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3AKCgpmcm9tIG1scnVuLnJ1bnRpbWVzIGltcG9ydCBudWNsaW9faW5pdF9ob29rCmRlZiBpbml0X2NvbnRleHQoY29udGV4dCk6CiAgICBudWNsaW9faW5pdF9ob29rKGNvbnRleHQsIGdsb2JhbHMoKSwgJ3NlcnZpbmcnKQoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgcmV0dXJuIGNvbnRleHQubWxydW5faGFuZGxlcihjb250ZXh0LCBldmVudCkK
        noBaseImagesPull: true
      env:
      - name: MODEL_CLASS
        value: ClassifierModel
      handler: ServeModel:handler
      runtime: python:3.6
      volumes: []
  source: ''
  function_kind: serving
